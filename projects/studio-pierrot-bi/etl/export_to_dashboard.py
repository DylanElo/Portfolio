import sqlite3
import json
import os
from datetime import datetime

DB_PATH = 'warehouse/pierrot_bi.db'
OUTPUT_PATH = 'dashboard/data.js'

def get_latest_data():
    """Query warehouse for latest anime metrics"""
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    
    # Get latest date_id
    cursor.execute('SELECT MAX(date_id) FROM dim_date')
    latest_date_id = cursor.fetchone()[0]
    
    if not latest_date_id:
        print("❌ No data found in dim_date")
        return []

    # Query joined data
    query = '''
    SELECT 
        a.mal_id as id,
        a.title,
        a.type,
        a.episodes,
        a.status,
        r.mal_score as score,
        r.mal_members as members,
        r.mal_favorites as favorites,
        r.mal_rank as rank,
        a.air_date_start as aired_from
    FROM fact_rating_snapshot r
    JOIN dim_anime a ON r.anime_id = a.anime_id
    WHERE r.date_id = ?
    ORDER BY r.mal_score DESC
    '''
    
    cursor.execute(query, (latest_date_id,))
    rows = cursor.fetchall()
    
    # Convert to list of dicts
    data = []
    for row in rows:
        item = dict(row)
        # Add static fields that might be missing from warehouse but needed for UI
        # In a real app, these would also be in the warehouse
        item['scored_by'] = 0 # Placeholder
        item['popularity'] = 0 # Placeholder
        item['rating'] = 'Unknown'
        item['image_url'] = '' # Placeholder
        item['url'] = f"https://myanimelist.net/anime/{item['id']}"
        data.append(item)
        
    conn.close()
    return data

def get_financial_data():
    """Query warehouse for financial/ROI metrics"""
    conn = sqlite3.connect(DB_PATH)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    
    # Query financial data
    query = '''
    SELECT 
        a.mal_id as id,
        a.title,
        f.tier,
        f.production_budget,
        f.streaming_revenue,
        f.disc_revenue,
        f.merch_revenue,
        f.total_revenue,
        f.profit,
        f.roi,
        f.profit_per_episode,
        a.episodes
    FROM fact_finance f
    JOIN dim_anime a ON f.anime_id = a.anime_id
    ORDER BY f.roi DESC
    '''
    
    cursor.execute(query)
    rows = cursor.fetchall()
    
    # Convert to list of dicts
    financial_data = [dict(row) for row in rows]
    
    conn.close()
    return financial_data

def export_to_js(data, financial_data):
    """Write data to JS file"""
    timestamp = datetime.now().isoformat()
    js_content = f"// Auto-generated by etl/export_to_dashboard.py on {timestamp}\n"
    js_content += f"// Source: SQLite Warehouse ({DB_PATH})\n"
    js_content += f"export const lastUpdated = '{timestamp}';\n"
    js_content += "export const animeData = " + json.dumps(data, indent=2) + ";\n"
    js_content += "export const financialData = " + json.dumps(financial_data, indent=2) + ";\n"
    
    with open(OUTPUT_PATH, 'w', encoding='utf-8') as f:
        f.write(js_content)
    
    print(f"✅ Exported {len(data)} records to {OUTPUT_PATH}")

if __name__ == '__main__':
    if not os.path.exists(DB_PATH):
        print(f"❌ Database not found: {DB_PATH}")
    else:
        data = get_latest_data()
        financial_data = get_financial_data()
        if data:
            export_to_js(data, financial_data)
            print(f"✅ Also exported {len(financial_data)} financial records")
